<?xml version="1.0" encoding="utf-8"?>
<templates>
    <t t-name="meeting_management_base.MeetingSessionView">
        <div class="dw-meeting-view" role="main">
            <!-- Header -->
            <header class="meeting-header">
                <div class="meeting-header-left">
                    <button class="btn-back" t-on-click="goBack" title="Back">
                        <i class="fa fa-arrow-left"/>
                    </button>
                    <div class="meeting-title-section">
                        <h1 class="meeting-title">
                            <t t-esc="state.session.name"/>
                        </h1>
                        <div class="meeting-meta-info">
                            <span class="meta-badge" t-if="state.session.is_host">
                                <i class="fa fa-star"/>
                                Host
                            </span>
                        </div>
                    </div>
                </div>
                <div class="meeting-header-right">
                    <span class="status-chip" t-att-class="state.session.state">
                        <span class="status-dot"/>
                        <t t-esc="state.session.state.charAt(0).toUpperCase() + state.session.state.slice(1).replace('_', ' ')"/>
                    </span>
                    <button class="btn-action danger" t-if="state.session.state !== 'done'" t-on-click="leaveMeeting"
                            title="Leave">
                        <i class="fa fa-sign-out"/>
                    </button>
                    <button class="btn-action danger" t-if="state.session.is_host and state.session.state !== 'done'"
                            t-on-click="endMeeting"
                            title="End Meeting for All">
                        <i class="fa fa-power-off"/>
                    </button>
                    <button class="btn-action primary" t-on-click="toggleCamera" title="Toggle Camera">
                        <i t-att-class="state.session.display_camera ? 'fa fa-eye-slash' : 'fa fa-eye'"/>
                    </button>
                </div>
            </header>

            <!-- Content Grid -->
            <div class="meeting-content-grid">
                <!-- Left Sidebar: Participants -->
                <aside class="meeting-sidebar">
                    <div class="sidebar-card">
                        <div class="card-header">
                            <h3>
                                <i class="fa fa-users"/>
                                Participants (<t t-esc="state.session.participants?.length"/>)
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="participants-list">
                                <t t-if="state.session.participants?.length">
                                    <t t-foreach="state.session.participants" t-as="p" t-key="p_index">
                                        <div class="participant-item">
                                            <div class="participant-avatar">
                                                <t t-esc="p.name.slice(0, 2).toUpperCase()"/>
                                                <span t-att-class="'status-badge status-' + (p.attendance_status || 'default')"
                                                      t-att-title="getStatusLabel(p.attendance_status)"/>
                                            </div>
                                            <div class="participant-info">
                                                <div class="participant-name">
                                                    <t t-esc="p.name"/>
                                                </div>
                                            </div>
                                            <div class="participant-status">
                                                <t t-if="p.attendance_status === 'present'">
                                                    <i class="fa fa-circle text-success"/>
                                                    Present
                                                </t>
                                                <t t-elif="p.attendance_status === 'late'">
                                                    <i class="fa fa-circle text-warning"/>
                                                    Late
                                                </t>
                                                <t t-elif="p.attendance_status === 'absent'">
                                                    <i class="fa fa-circle text-danger"/>
                                                    Absent
                                                </t>
                                                <t t-elif="p.attendance_status === 'excused'">
                                                    <i class="fa fa-circle text-muted"/>
                                                    Excused
                                                </t>
                                                <t t-else="">
                                                    <i class="fa fa-circle text-secondary"/>
                                                    Awaiting
                                                </t>
                                            </div>
                                        </div>
                                    </t>
                                </t>
                                <t t-else="">
                                    <div class="empty-participants">
                                        <i class="fa fa-users"/>
                                        <p>No participants</p>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>

                    <!-- Waiting Participants (only for hosts) -->
                    <div class="sidebar-card" t-if="state.session.is_host &amp;&amp; state.waitingParticipants.length">
                        <div class="card-header">
                            <h3>
                                <i class="fa fa-hourglass"/>
                                Waiting (<t t-esc="state.waitingParticipants.length"/>)
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="participants-list">
                                <t t-foreach="state.waitingParticipants" t-as="w" t-key="w.id">
                                    <div class="participant-item">
                                        <div class="participant-avatar">
                                            <t t-esc="w.name?.slice(0, 2).toUpperCase()"/>
                                        </div>
                                        <div class="participant-info">
                                            <div class="participant-name">
                                                <t t-esc="w.name"/>
                                            </div>
                                        </div>
                                        <div style="display:flex; gap:4px;">
                                            <button class="btn-icon-sm"
                                                    t-on-click="() => admitParticipant(w.id)"
                                                    title="Admit">
                                                <i class="fa fa-check" style="color: #10b981;"/>
                                            </button>
                                            <button class="btn-icon-sm"
                                                    t-on-click="() => rejectParticipant(w.id)"
                                                    title="Reject">
                                                <i class="fa fa-times" style="color: #ef4444;"/>
                                            </button>
                                        </div>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>

                    <!-- Meeting Info -->
                    <div class="sidebar-card">
                        <div class="card-header">
                            <h3>
                                <i class="fa fa-info-circle"/>
                                Details
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="info-list">
                                <div class="info-item" t-if="state.session.objet">
                                    <label>Subject</label>
                                    <span t-esc="state.session.objet"/>
                                </div>
                                <div class="info-item" t-if="state.session.meeting_type_id">
                                    <label>Type</label>
                                    <span t-esc="state.meetingTypeName"/>
                                </div>
                                <div class="info-item" t-if="state.session.planned_start_datetime">
                                    <label>Planned start</label>
                                    <span t-esc="state.session.planned_start_datetime"/>
                                </div>
                                <div class="info-item" t-if="state.session.planned_end_time">
                                    <label>Planned end</label>
                                    <span t-esc="state.session.planned_end_time"/>
                                </div>
                                <div class="info-item">
                                    <label>Planned Duration</label>
                                    <span>
                                        <t t-esc="state.sessionDuration"/>
                                        hours
                                    </span>
                                </div>
                                <div class="info-item">
                                    <label>Actual start</label>
                                    <span>
                                        <t t-esc="state.session.actual_start_datetime"/>
                                    </span>
                                </div>
                                <div class="info-item">
                                    <label>Elapsed Time</label>
                                    <span t-esc="state.meetingDuration"/>
                                </div>
                                <div class="info-item" t-if="state.session.join_datetime">
                                    <label>Joined At</label>
                                    <span t-esc="state.formattedJoinTime"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>

                <!-- Main: Tabbed Content with Navigation -->
                <main class="meeting-main">
                    <!-- Tab Navigation Bar -->
                    <div class="main-tab-navigation">
                        <button
                                class="tab-nav-button"
                                t-att-class="{ 'active': state.activeMainTab === 'agenda' }"
                                t-on-click="() => onTabChange('agenda')">
                            <i class="fa fa-file-text-o"/>
                            <span>Agenda</span>
                        </button>
                        <button
                                class="tab-nav-button"
                                t-att-class="{ 'active': state.activeMainTab === 'actions' }"
                                t-on-click="() => onTabChange('actions')">
                            <i class="fa fa-tasks"/>
                            <span>Actions (<t t-esc="state.actions.length"/>)
                            </span>
                        </button>
                        <button
                                class="tab-nav-button"
                                t-att-class="{ 'active': state.activeMainTab === 'notes' }"
                                t-on-click="() => onTabChange('notes')">
                            <i class="fa fa-file-text-o"/>
                            <span>My Notes</span>
                        </button>
                        <button
                                class="tab-nav-button"
                                t-att-class="{ 'active': state.activeMainTab === 'pv' }"
                                t-on-click="() => onTabChange('pv')">
                            <i class="fa fa-file-text-o"/>
                            <span>PV</span>
                        </button>
                        <button
                                class="tab-nav-button"
                                t-att-class="{ 'active': state.activeMainTab === 'video' }"
                                t-on-click="() => onTabChange('video')"
                                t-if="state.session.display_camera">
                            <i class="fa fa-video-camera"/>
                            <span>Video Conference</span>
                        </button>
                    </div>

                    <!-- Video Conference Section - Always rendered but hidden when not active -->
                    <div class="main-tab-content" t-att-class="{'d-none': state.activeMainTab !== 'video'}">
                        <div class="video-conference-container">
                            <!-- Jitsi container always in DOM, just hidden with CSS -->
                            <div id="jitsi-meet-container"
                                 class="jitsi-container"
                                 t-att-class="{'d-none': state.activeMainTab !== 'video'}"/>

                            <!-- Loading -->
                            <div class="video-loading"
                                 t-if="state.loading &amp;&amp; !state.error &amp;&amp; state.activeMainTab === 'video'">
                                <div class="loading-spinner">
                                    <div class="spinner-ring"/>
                                </div>
                                <p>Loading meeting session...</p>
                            </div>

                            <!-- Error -->
                            <div class="video-error" t-if="state.error &amp;&amp; state.activeMainTab === 'video'">
                                <div class="error-icon">
                                    <i class="fa fa-exclamation-triangle"/>
                                </div>
                                <h3>Connection Error</h3>
                                <p t-esc="state.error"/>
                                <div class="error-actions">
                                    <button class="btn-retry" t-on-click="retryConnection">
                                        <i class="fa fa-refresh"/>
                                        Retry
                                    </button>
                                    <button class="btn-secondary" t-on-click="goBack">
                                        <i class="fa fa-arrow-left"/>
                                        Back
                                    </button>
                                </div>
                            </div>

                            <!-- Timer -->
                            <div class="meeting-timer"
                                 t-if="state.jitsiLoaded &amp;&amp; state.activeMainTab === 'video'">
                                <i class="fa fa-circle recording-indicator"/>
                                <span t-esc="state.meetingDuration"/>
                            </div>
                        </div>
                    </div>

                    <!-- Agenda Section -->
                    <div class="main-tab-content" t-if="state.activeMainTab === 'agenda'">
                        <div class="meeting-actions-section">
                            <div class="actions-header">
                                <h3>
                                    <i class="fa fa-list"/>
                                    Agenda Items
                                </h3>
                            </div>
                            <div class="agenda-body">
                                <t t-if="state.session.subject_order?.length">
                                    <t t-foreach="state.session.subject_order" t-as="item" t-key="item.id">
                                        <div class="agenda-item">
                                            <div class="agenda-title">
                                                <t t-esc="item.name"/>
                                            </div>
                                            <div class="agenda-description" t-if="item.description">
                                                <t t-esc="item.description"/>
                                            </div>
                                        </div>
                                    </t>
                                </t>
                                <t t-else="">
                                    <div class="empty-agenda">
                                        <p>No agenda items</p>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>

                    <!-- Actions Section -->
                    <div class="main-tab-content" t-if="state.activeMainTab === 'actions'">
                        <div class="meeting-actions-section">
                            <div class="actions-header">
                                <h3>
                                    <i class="fa fa-tasks"/>
                                    My Action Items (<t t-esc="state.actions.length"/>)
                                </h3>
                                <div class="actions-header-actions">
                                    <button class="btn-add-action" t-on-click="addNewAction">
                                        <i class="fa fa-plus"/>
                                        Add Action
                                    </button>
                                </div>
                            </div>
                            <div class="actions-body">
                                <div class="actions-list">
                                    <t t-if="state.actions.length">
                                        <t t-foreach="state.actions" t-as="action" t-key="action.id || action_index">
                                            <div class="action-item" t-att-data-status="action.status">
                                                <div class="action-item-header">
                                                    <input
                                                            type="text"
                                                            class="action-title-input"
                                                            t-model="action.name"
                                                            placeholder="Action title..."
                                                            t-on-change="() => updateAction(action)"/>
                                                    <button class="btn-delete-action"
                                                            t-on-click="() => deleteAction(action)">
                                                        <i class="fa fa-trash"/>
                                                    </button>
                                                </div>
                                                <div class="action-item-body">
                                                    <div class="action-fields-grid">

                                                        <div class="action-field">
                                                            <label>
                                                                <i class="fa fa-user"/>
                                                                Assigned to:
                                                            </label>
                                                            <select
                                                                    t-model="action.assignee_id"
                                                                    t-on-change="() => updateAction(action)"
                                                                    class="form-select">
                                                                <option value="">Select assignee...</option>
                                                                <t t-foreach="state.availableAssignees" t-as="assignee"
                                                                   t-key="assignee.id">
                                                                    <option t-att-value="assignee.id"
                                                                            t-att-selected="action.assignee_id == assignee.id">
                                                                        <t t-esc="assignee.name"/>
                                                                    </option>
                                                                </t>
                                                            </select>
                                                        </div>
                                                        <div class="action-field">
                                                            <label>
                                                                <i class="fa fa-calendar"/>
                                                                Due Date:
                                                            </label>
                                                            <input
                                                                    type="date"
                                                                    t-model="action.dead_line"
                                                                    t-on-change="() => updateAction(action)"/>
                                                        </div>
                                                        <div class="action-field">
                                                            <label>
                                                                <i class="fa fa-flag"/>
                                                                Priority:
                                                            </label>
                                                            <select t-model="action.priority"
                                                                    t-on-change="() => updateAction(action)">
                                                                <option value="1">Low</option>
                                                                <option value="0">Normal</option>
                                                                <option value="2">High</option>
                                                                <option value="3">Urgent</option>
                                                            </select>
                                                        </div>
                                                        <div class="action-field">
                                                            <label>
                                                                <i class="fa fa-tasks"/>
                                                                Status:
                                                            </label>
                                                            <select t-model="action.status"
                                                                    t-on-change="() => updateAction(action)">
                                                                <option value="todo">To Do</option>
                                                                <option value="in_progress">In Progress</option>
                                                                <option value="done">Done</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </t>
                                    </t>
                                    <t t-else="">
                                        <div class="empty-actions">
                                            <i class="fa fa-tasks"/>
                                            <p>No action items yet</p>
                                            <button class="btn btn-primary btn-sm" t-on-click="addNewAction">
                                                <i class="fa fa-plus"/>
                                                Add First Action
                                            </button>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="main-tab-content" t-if="state.activeMainTab === 'notes'">
                        <div class="meeting-notes-section">
                            <div class="notes-header">
                                <h3>
                                    <i class="fa fa-file-text-o"/>
                                    My Notes
                                </h3>
                                <div class="notes-actions">
                                    <button class="btn-save-notes" t-on-click="saveNotes">
                                        <i class="fa fa-save"/>
                                        Save
                                    </button>
                                </div>
                            </div>
                            <div class="notes-editor">
                                <textarea
                                        class="notes-textarea"
                                        placeholder="Type your personal notes here..."
                                        t-model="state.notes"/>
                            </div>
                        </div>
                    </div>

                    <!-- PV Section -->
                    <div class="main-tab-content" t-if="state.activeMainTab === 'pv'">
                        <div class="meeting-notes-section">
                            <div class="notes-header">
                                <h3>
                                    <i class="fa fa-file-text-o"/>
                                    Procès-Verbal (PV)
                                </h3>
                                <div class="notes-actions">
                                    <!-- Template Selection Buttons -->
                                    <button class="btn-save-notes" t-on-click="startBlankPv"
                                            title="Start with blank PV">
                                        <i class="fa fa-file-o"/>
                                        <span>PV Personnalisé</span>
                                    </button>
                                    <button class="btn-save-notes" t-on-click="loadPvTemplate" title="Load PV template">
                                        <i class="fa fa-file-text"/>
                                        <span>Charger Modèle</span>
                                    </button>
                                    <!-- Save Button -->
                                    <button class="btn-save-notes" t-on-click="savePv">
                                        <i class="fa fa-save"/>
                                        Save
                                    </button>
                                </div>
                            </div>
                            <div class="notes-editor">
                                <textarea
                                        class="notes-textarea pv-textarea"
                                        placeholder="Rédigez votre procès-verbal ici...&#10;&#10;Utilisez 'Charger Modèle' pour un modèle pré-rempli ou 'PV Vierge' pour commencer de zéro."
                                        t-model="state.pv"
                                />
                            </div>
                            <!-- Character/Word Count -->
                            <div class="pv-footer">
                                <div class="pv-stats">
                                    <span class="stat-item">
                                        <i class="fa fa-font"/>
                                        <t t-esc="state.pv.length"/>
                                        caractères
                                    </span>
                                </div>
                                <div class="pv-help">
                                    <i class="fa fa-info-circle"/>
                                    <span>Le PV est automatiquement sauvegardé avec la réunion</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </t>
</templates>